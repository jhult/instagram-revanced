name: 1. Manual Patch
permissions: write-all
env:
  repository: ${{ github.repository }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Which variant do you want to patch?'
        required: true
        default: 'revanced'
        type: choice
        options:
          - 'morphe'
          - 'morphe-beta'
          - 'revanced'
          - 'revanced-beta'
          - 'revanced-extended'
          - 'revanced-extended-beta'
          - 'revanced-extended-arsclib'
          - 'revanced-extended-android5'
          - 'revanced-extended-android67'
          - 'revanced-liso'
          - 'rve-anddea-stable'
          - 'rve-anddea-beta'
          - 'piko-stable'
          - 'piko-beta'
          - 'biliroamingm'
          - 'scrazzz'
          - 'dropped-patches'
          - 'revanced-experiments'
          - 'instafel'
  workflow_call:
    inputs:
      variant:
        required: true
        type: string

jobs:
  # Unified patch job - replaces 16+ individual variant jobs
  patch:
    name: ${{ matrix.app }} (${{ inputs.variant || github.event.inputs.variant }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # App names from src/config/apps.conf
        # Each app is built independently in parallel
        app:
          - youtube
          - youtube-lite
          - youtube-music
          - gg-photos
          - newsstand
          - instagram
          - facebook
          - messenger
          - threads
          - reddit
          - twitter
          - twitch
          - tumblr
          - soundcloud
          - spotify
          - tiktok
          - pixiv
          - rar
          - lightroom
          - bilibili
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Preparing to patch
        uses: ./.github/actions/preparing

      - name: Check github connection
        id: check-gh
        run: bash src/etc/connection.sh

      - name: Patch APK
        id: patch
        if: steps.check-gh.outputs.internet_error == '0'
        run: |
          bash src/build/build-unified.sh "${{ inputs.variant || github.event.inputs.variant }}" ${{ matrix.app }}

      - name: Releasing APK files
        id: release
        if: steps.check-gh.outputs.internet_error == '0'
        uses: ./.github/actions/release
